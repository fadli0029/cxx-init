#!/bin/bash

set -e

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

if [[ "$1" =~ ^(-h|--help|h|help)$ ]]; then
  echo "Usage: cxx-init <project-name>"
  echo ""
  echo "Create a new C++ project with CMake, C++23 modules, clang-format, and clang-tidy."
  echo ""
  echo "Arguments:"
  echo "  project-name    Name of the project directory to create."
  exit 0
fi

if [[ -z "$1" ]]; then
  echo "Usage: cxx-init <project-name>"
  exit 1
fi

name="$1"

if [[ -d "$name" ]]; then
  echo "Error: directory '$name' already exists"
  exit 1
fi

mkdir -p "$name"/{src,include}
cd "$name"

# .clangd
cat > .clangd << 'EOF'
CompileFlags:
  CompilationDatabase: "build"
EOF

# .clangd-modules is a marker file for clangd-wrapper (a wrapper script that runs clangd with
# --experimental-modules-support when this file exists). This enables C++20 modules support in clangd.
# This is harmless if you don't use such a wrapper because it's just an empty file.
touch .clangd-modules

# .clang-tidy and .clang-format
cp "$SCRIPT_DIR/.clang-tidy" .
cp "$SCRIPT_DIR/.clang-format" .

# CMakeLists.txt
cat > CMakeLists.txt << EOF
cmake_minimum_required(VERSION 4.0...4.1)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
# Experimental UUID for import std; may change with CMake updates
# Check: https://github.com/Kitware/CMake/blob/master/Help/dev/experimental.rst
set(CMAKE_EXPERIMENTAL_CXX_IMPORT_STD "d0edc3af-4c50-42ea-a356-e2862fe7a444")

# Hardening flags (OpenSSF recommended) - set via CMAKE_CXX_FLAGS for C++23 module compatibility
# Flags must apply to both the internal std module target and user code
# https://best.openssf.org/Compiler-Hardening-Guides/Compiler-Options-Hardening-Guide-for-C-and-C++
# https://discourse.cmake.org/t/error-module-file-cmakefiles-cmake-cxx23-dir-std-pcm-cannot-be-loaded-due-to-a-configuration-mismatch-with-the-current-compilation/13276
set(HARDENING_FLAGS "-fstack-protector-strong -fstack-clash-protection -fcf-protection=full")
set(CMAKE_CXX_FLAGS_RELEASE "\${CMAKE_CXX_FLAGS_RELEASE} \${HARDENING_FLAGS}")
set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "\${CMAKE_CXX_FLAGS_RELWITHDEBINFO} \${HARDENING_FLAGS}")

project($name LANGUAGES CXX)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_CXX_SCAN_FOR_MODULES ON)

# _FORTIFY_SOURCE breaks Clang C++23 modules: https://github.com/llvm/llvm-project/issues/121709
if((CMAKE_BUILD_TYPE STREQUAL "Release" OR CMAKE_BUILD_TYPE STREQUAL "RelWithDebInfo") AND CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
  add_compile_definitions(_FORTIFY_SOURCE=3)
endif()

# Executables: add new targets here as "name src/file.cpp"
set(TARGETS
  $name src/main.cpp
)

# Process targets in pairs: name, source
list(LENGTH TARGETS TARGETS_LEN)
math(EXPR TARGETS_LAST "\${TARGETS_LEN} - 1")
foreach(i RANGE 0 \${TARGETS_LAST} 2)
  math(EXPR j "\${i} + 1")
  list(GET TARGETS \${i} target_name)
  list(GET TARGETS \${j} target_src)

  add_executable(\${target_name} \${target_src})
  target_include_directories(\${target_name} PRIVATE include)
  set_target_properties(\${target_name} PROPERTIES CXX_MODULE_STD 1)

  # Warnings: cpp-best-practices recommended set
  # https://github.com/cpp-best-practices/cppbestpractices/blob/master/02-Use_the_Tools_Available.md
  target_compile_options(\${target_name} PRIVATE
    # Base warnings
    -Wall -Wextra -Wpedantic
    -Wshadow                # Warn on shadowed variables
    -Wconversion            # Warn on implicit type conversions that may lose data
    -Wsign-conversion       # Warn on sign conversions
    -Wnon-virtual-dtor      # Warn if base with virtual functions lacks virtual destructor
    -Woverloaded-virtual    # Warn if function hides virtual from base (signature mismatch)
    -Wold-style-cast        # Warn on C-style casts
    -Wcast-align            # Warn on potential performance issues from pointer casts
    -Wunused                # Warn on unused entities
    -Wformat=2              # Enhanced format string checks (security)
    -Wimplicit-fallthrough  # Warn on implicit switch fallthrough
    -Wdouble-promotion      # Warn on implicit float->double promotion
    -Wnull-dereference      # Warn on potential null pointer dereference
  )

  # GCC-specific warnings
  target_compile_options(\${target_name} PRIVATE
    \$<\$<CXX_COMPILER_ID:GNU>:-Wduplicated-cond>       # Warn on duplicated if-else conditions
    \$<\$<CXX_COMPILER_ID:GNU>:-Wduplicated-branches>   # Warn on duplicated if-else branches
    \$<\$<CXX_COMPILER_ID:GNU>:-Wlogical-op>            # Warn on suspicious logical operations
    \$<\$<CXX_COMPILER_ID:GNU>:-Wuseless-cast>          # Warn on useless casts
  )

  if(STRICT_WARNINGS)
    target_compile_options(\${target_name} PRIVATE -Werror)
  endif()

  if(ENABLE_SANITIZERS)
    target_compile_options(\${target_name} PRIVATE -fsanitize=address,undefined -fno-omit-frame-pointer)
    target_link_options(\${target_name} PRIVATE -fsanitize=address,undefined)
  endif()

  # Debug: runtime assertions
  if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(\${target_name} PRIVATE _GLIBCXX_ASSERTIONS)
  endif()
endforeach()
EOF

# build.sh
cp "$SCRIPT_DIR/build.sh" .
chmod +x build.sh

# src/main.cpp
cat > src/main.cpp << 'EOF'
import std;

int main() {
  std::println("Hello, World!");
  return 0;
}
EOF

echo "Created $name/"
echo "  src/main.cpp"
echo "  include/"
echo "  CMakeLists.txt"
echo "  build.sh"
echo "  .clangd"
echo "  .clangd-modules"
echo "  .clang-tidy"
echo "  .clang-format"
